<!doctype html>
<html lang="en">
	<head>
		<title>Face substitution</title>
		<meta charset="utf-8">
		<style>
			@import url(https://fonts.googleapis.com/css?family=Lato:300italic,700italic,300,700);

			body {
				font-family: 'Lato';
				background-color: #f0f0f0;
				margin: 0px auto;
				max-width: 1150px;
			}
			
			#overlay, #webgl {
				position: absolute;
				top: 0px;
				left: 0px;
				-o-transform : scaleX(-1);
				-webkit-transform : scaleX(-1);
				transform : scaleX(-1);
				-ms-filter : fliph; /*IE*/
				filter : fliph; /*IE*/

				width : 600px;
				height : 450px;
			}

			#videoel {
				-o-transform : scaleX(-1);
				-webkit-transform : scaleX(-1);
				transform : scaleX(-1);
				-ms-filter : fliph; /*IE*/
				filter : fliph; /*IE*/

				width : 600px;
				height : 450px;
			}

			#container {
				position : relative;
				width : 370px;
			}
			
			#content {
				margin-top : 50px;
				margin-left : auto;
				margin-right : auto;
				max-width: 600px;
			}
			 
			#sketch {
				display: none;
			}

			h2 {
				font-weight : 400;
			}

			.masks {
				display: none;
			}
			
			.btn {
				font-family: 'Lato';
				font-size: 16px;
			}

			#webgl2 {
				display : none;
			}

			#controls {
				text-align : center;
			}
		</style>
		<script>
			// getUserMedia only works over https in Chrome 47+, so we redirect to https. Also notify user if running from file.
			if (window.location.protocol == "file:") {
				alert("You seem to be running this example directly from a file. Note that these examples only work when served from a server or localhost due to canvas cross-domain restrictions.");
			} else if (window.location.hostname !== "localhost" && window.location.protocol !== "https:"){
				window.location.protocol = "https";
			}
		</script>
	</head>
	<body>
		<script src="../js/dat.gui.min.js"></script>
		<script src="../js/utils.js"></script>
		<script src="../js/clmtrackr.js"></script>
		<script src="../models/model_pca_20_svm.js"></script>
		<script src="../js/Stats.js"></script>
		<script src="../js/face_deformer.js"></script>
		<script src="../js/jquery.min.js"></script>
		<script src="./js/poisson_new.js"></script>
		
		<div id="content">
			<h2>Face substitution</h2>
			<div id="container">
				<video id="videoel" width="400" height="300" preload="auto">
				</video>
				<canvas id="overlay" width="400" height="300"></canvas>
				<canvas id="webgl" width="400" height="300"></canvas>
			</div>
			<br/>
			<div id="controls">
				<input class="btn" type="button" value="wait, loading video & images" disabled="disabled" onclick="startVideo()" id="startbutton"></input>
				<select name="mask" id="selectmask">
					<option value="0">Average face</option>
					<option value="1">Terminator</option>
					<option value="2">Walter</option>
					<option value="3">Clooney</option>
					<option value="4">Bieber</option>
					<option value="5">Kim</option>
					<option value="6">Rihanna</option>
					<option value="7">Audrey Hepburn</option>
					<option value="8">Bill Murray</option>
					<option value="9">Sean Connery</option>
					<option value="10">Cage</option>
					<option value="11">The Queen</option>
					<option value="12">Obama</option>
					<option value="13">Chuck Norris</option>
					<option value="14">Mona Lisa</option>
					<option value="15">Picasso</option>
					<option value="16">Abstract (Scream)</option>
					<option value="17">Facebook</option>
					<option value="18">Custom</option>
				</select>
			</div>
			<div id="text">
				<p>This is a demo of <em>face substitution</em> using the javascript library <a href="https://github.com/auduno/clmtrackr"><em>clmtrackr</em></a>. Keep your face still until the facemodel has fitted and try out different masks from the dropdown.</p>
				<p>Note that the face substitution works best with good, even lighting. The demo also needs support for WebGL, and works best in Google Chrome.</p>
				<p>The demo was inspired by Kyle McDonald & Arturo Castro's <a href="http://vimeo.com/29348533">face substitution</a>, and includes bits from <a href="https://github.com/wellflat/javascript-labs/">a computer vision library</a> by wellflat for blending the faces.</p>
				<p>If you liked this demo, you should <a href="http://www.twitter.com/matsiyatzy">follow me on twitter</a>!</p>
			</div>
			<a href="https://github.com/auduno/clmtrackr"><img style="position: absolute; top: 0; left: 0; border: 0;" src="https://s3.amazonaws.com/github/ribbons/forkme_left_green_007200.png" alt="Fork me on GitHub"></a>
			<canvas id="webgl2" width="400" height="300"></canvas>
			<script>
				var images = [
					{"id":"average", 	"path":"./media/average2_crop.jpg"},
					{"id":"terminator", "path":"./media/terminator_crop.jpg"},
					{"id":"walter2", 	"path":"./media/walter2_crop.jpg"},
					{"id":"clooney2", 	"path":"./media/fragrance-George-Clooney-main_crop.jpg"},
					{"id":"bieber", 	"path":"./media/Justin-Bieber2_crop.jpg"},
					{"id":"kim", 		"path":"./media/kim1_crop.jpg"},
					{"id":"rihanna", 	"path":"./media/ri_1_crop.jpg"},
					{"id":"audrey", 	"path":"./media/audrey_crop.jpg"},
					{"id":"bill", 		"path":"./media/bill-murray-snl_crop.jpg"},
					{"id":"connery2", 	"path":"./media/sean_guru2_crop.jpg"},
					{"id":"cage3", 		"path":"./media/cage2_crop.jpg"},
					{"id":"queen", 		"path":"./media/queen20_crop.jpg"},
					{"id":"obama4", 	"path":"./media/obama4_crop.jpg"},
					{"id":"chuck", 		"path":"./media/chuck_crop.jpg"},
					{"id":"monalisa", 	"path":"./media/joconde_crop.jpg"},
					{"id":"picasso1", 	"path":"./media/picasso_drawing_crop.jpg"},
					{"id":"scream", 	"path":"./media/scream_crop.jpg"},
					{"id":"fb", 		"path":"fb"},
					{"id":"custom", 	"path":null}
				];

				// when everything is ready, automatically start everything ?

				var vid = document.getElementById('videoel');
				var overlay = document.getElementById('overlay');
				var overlayCC = overlay.getContext('2d');	
				
				/*********** Setup of video/webcam and checking for webGL support *********/

				var videoReady = false;
				
				function enablestart() {
					if (videoReady) {
						var startbutton = document.getElementById('startbutton');
						startbutton.value = "start";
						startbutton.disabled = null;
					}
				}

				$(window).load(function() {
    				enablestart();
				});
				
				var insertAltVideo = function(video) {
					if (supports_video()) {
						if (supports_ogg_theora_video()) {
							video.src = "../media/cap13_edit2.ogv";
						} else if (supports_h264_baseline_video()) {
							video.src = "../media/cap13_edit2.mp4";
						} else {
							return false;
						}
						//video.play();
						return true;
					} else return false;
				}

				// check whether browser supports webGL
				var webGLContext;
				var webGLTestCanvas = document.createElement('canvas');
				if (window.WebGLRenderingContext) {
					webGLContext = webGLTestCanvas.getContext('webgl') || webGLTestCanvas.getContext('experimental-webgl');
					if (!webGLContext || !webGLContext.getExtension('OES_texture_float')) {
						webGLContext = null;
					}
				}
				if (webGLContext == null) {
					alert("Your browser does not seem to support WebGL. Unfortunately this face mask example depends on WebGL, so you'll have to try it in another browser. :(");
				}
				
				navigator.getUserMedia = navigator.getUserMedia || navigator.webkitGetUserMedia || navigator.mozGetUserMedia || navigator.msGetUserMedia;
				window.URL = window.URL || window.webkitURL || window.msURL || window.mozURL;
				
				// check for camerasupport
				if (navigator.getUserMedia) {
					// set up stream
					
					// chrome 19 shim
					var videoSelector = {video : true};
					if (window.navigator.appVersion.match(/Chrome\/(.*?) /)) {
						var chromeVersion = parseInt(window.navigator.appVersion.match(/Chrome\/(\d+)\./)[1], 10);
						if (chromeVersion < 20) {
							videoSelector = "video";
						}
					};
					
					navigator.getUserMedia(videoSelector, function( stream ) {
						if (vid.mozCaptureStream) {
							vid.mozSrcObject = stream;
						} else {
							vid.src = (window.URL && window.URL.createObjectURL(stream)) || stream;
						}
						vid.play();
					}, function() {
						insertAltVideo(vid);
						alert("There was some problem trying to fetch video from your webcam, using a fallback video instead.");
					});
				} else {
					insertAltVideo(vid);
					alert("Your browser does not seem to support getUserMedia, using a fallback video instead.");
				}

				vid.addEventListener('canplay', function() {videoReady = true;enablestart();}, false);

				/*********** Code for face substitution *********/
				
				var animationRequest;
				var positions;

				var ctrack = new clm.tracker();
				ctrack.init(pModel);

				var maskTrack = new clm.tracker();
				maskTrack.init(pModel);

				document.getElementById('selectmask').addEventListener('change', updateMask, false);

				function updateMask(el) {
					currentMask = images[parseInt(el.target.value, 10)];
					switchMasks();
				}

				function startVideo() {
					// start video
					vid.play();
					// start tracking
					ctrack.start(vid);
					// start drawing face grid
					drawGridLoop();
				}

				var fd = new faceDeformer();
				fd.init(document.getElementById('webgl'));
				var wc1 = document.getElementById('webgl').getContext('webgl') || document.getElementById('webgl').getContext('experimental-webgl')
				wc1.clearColor(0,0,0,0);

				var fd2 = new faceDeformer();
				fd2.init(document.getElementById('webgl2'));
				var wc2 = document.getElementById('webgl2').getContext('webgl') || document.getElementById('webgl2').getContext('experimental-webgl')
				wc2.clearColor(0,0,0,0);
				
				var currentMask = images[0];
				
				// canvas for copying the warped face to
				var newcanvas = document.createElement('CANVAS');
				newcanvas.width = vid.width;
				newcanvas.height = vid.height;
				// canvas for copying videoframes to
				var videocanvas = document.createElement('CANVAS');
				videocanvas.width = vid.width;
				videocanvas.height = vid.height;
				// canvas for masking
				var maskcanvas = document.createElement('CANVAS');
				maskcanvas.width = vid.width;
				maskcanvas.height = vid.height;

				// create canvases for all the faces
				var imageCanvases = {};
				loadMask = function(callback){
					var mask = new Image();
					mask.onload = function(obj){
						// copy the images to canvases
						imagecanvas = document.createElement('CANVAS');
						imagecanvas.width = obj.target.width;
						imagecanvas.height = obj.target.height;
						imagecanvas.getContext('2d').drawImage(obj.target,0,0);
		   				if (imageCanvases[currentMask.id]) {
		   					$(imageCanvases[currentMask.id]).remove();
		   				}
						imageCanvases[currentMask.id] = imagecanvas;

						enablestart();
						callback && callback();
					}
					mask.crossOrigin = "Anonymous";
					if (currentMask.path == null) {
					   mask.src = prompt("Mask url");
					}
					else if (currentMask.path == "fb") {
						selectFbFriend();
					}
					else {
						mask.src = currentMask.path;
					}
				}

				var extended_vertices = [
				  [0,71,72,0],
				  [0,72,1,0],
				  [1,72,73,1],
				  [1,73,2,1],
				  [2,73,74,2],
				  [2,74,3,2],
				  [3,74,75,3],
				  [3,75,4,3],
				  [4,75,76,4],
				  [4,76,5,4],
				  [5,76,77,5],
				  [5,77,6,5],
				  [6,77,78,6],
				  [6,78,7,6],
				  [7,78,79,7],
				  [7,79,8,7],
				  [8,79,80,8],
				  [8,80,9,8],
				  [9,80,81,9],
				  [9,81,10,9],
				  [10,81,82,10],
				  [10,82,11,10],
				  [11,82,83,11],
				  [11,83,12,11],
				  [12,83,84,12],
				  [12,84,13,12],
				  [13,84,85,13],
				  [13,85,14,13],
				  [14,85,86,14],
				  [14,86,15,14],
				  [15,86,87,15],
				  [15,87,16,15],
				  [16,87,88,16],
				  [16,88,17,16],
				  [17,88,89,17],
				  [17,89,18,17],
				  [18,89,90,18],
				  [18,90,22,18],
				  [22,90,21,22],
				  [21,90,91,21],
				  [21,20,91,21],
				  [20,91,92,20],
				  [20,92,19,20],
				  [19,92,93,19],
				  [19,93,71,19],
				  [19,0,71,19],
				  [44,61,56,44],
				  [60,61,56,60],
				  [60,56,57,60],
				  [60,59,57,60],
				  [58,59,57,58],
				  [58,59,50,58]
				];

				function drawGridLoop() {
					// get position of face
					positions = ctrack.getCurrentPosition(vid);

					overlayCC.clearRect(0, 0, 500, 375);
					if (positions) {
						// draw current grid
						ctrack.draw(overlay);
					}
					// check whether mask has converged
					var pn = ctrack.getConvergence();
					if (pn < 0.4) {
						switchMasks();
					} else {
						requestAnimFrame(drawGridLoop);
					}
				}

				function updateMaskPositionLoop() {
					var positions = maskTrack.getCurrentPosition();
					var pn = maskTrack.getConvergence();
					if (positions) {
						prepareMask();
					}
					if (positions && pn < 0.4) {
						maskTrack.stop();
					}
					else {
						requestAnimFrame(updateMaskPositionLoop);
					}
				}
					
				function switchMasks() {
					if (!ctrack.getCurrentPosition()) {
						return;
					}
					videocanvas.getContext('2d').drawImage(vid,0,0,videocanvas.width,videocanvas.height);

					maskTrack.stop();
					maskTrack.reset();
					loadMask(function() {
						maskTrack.start(imageCanvases[currentMask.id]);
						updateMaskPositionLoop();
					});
				}

				function prepareMask() {
					
					// we need to extend the positions with new estimated points in order to get pixels immediately outside mask
					var pos = ctrack.getCurrentPosition();
					var newMaskPos = maskTrack.getCurrentPosition().slice(0);
					var newFacePos = pos.slice(0);
					var extInd = [0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,22,21,20,19];
					var newp;
					for (var i = 0;i < 23;i++) {
						newp = [];
						newp[0] = (newMaskPos[extInd[i]][0]*1.3) - (newMaskPos[62][0]*0.3);// short for ((newMaskPos[extInd[i]][0]-newMaskPos[62][0])*1.1)+newMaskPos[62][0]
						newp[1] = (newMaskPos[extInd[i]][1]*1.3) - (newMaskPos[62][1]*0.3);
						newMaskPos.push(newp);
						newp = [];
						newp[0] = (newFacePos[extInd[i]][0]*1.3) - (newFacePos[62][0]*0.3);
						newp[1] = (newFacePos[extInd[i]][1]*1.3) - (newFacePos[62][1]*0.3);
						newFacePos.push(newp);
					}
					// also need to make new vertices incorporating area outside mask
					var newVertices = pModel.path.vertices.concat(extended_vertices);

					// deform the mask we want to use to face form
					fd2.load(imageCanvases[currentMask.id], newMaskPos, pModel, newVertices);
					fd2.draw(newFacePos);
					// and copy onto new canvas
					newcanvas.getContext('2d').drawImage(document.getElementById('webgl2'),0,0);

					// create masking
					var tempcoords = positions.slice(0,18);
					tempcoords.push(positions[21]);
					tempcoords.push(positions[20]);
					tempcoords.push(positions[19]);
					createMasking(maskcanvas, tempcoords);

					/*document.body.appendChild(newcanvas);
					document.body.appendChild(videocanvas);
					document.body.appendChild(maskcanvas);
					debugger;*/

					// do poisson blending
					Poisson.load(newcanvas, videocanvas, maskcanvas, function() {
						var result = Poisson.blend(30, 0, 0);
						// render to canvas
						newcanvas.getContext('2d').putImageData(result, 0, 0);
						// get mask

						fd.load(newcanvas, pos, pModel);
						requestAnimFrame(drawMaskLoop);
					});
				}
				
				function drawMaskLoop() {
					// get position of face
					positions = ctrack.getCurrentPosition();
					
					/*for (var i = 0;i < positions.length;i++) {
						positions[i][1] += 1;
					}*/

					overlayCC.clearRect(0, 0, 400, 300);
					if (positions) {
						// draw mask on top of face
						fd.draw(positions);
					}
					animationRequest = requestAnimFrame(drawMaskLoop);
				}

				function createMasking(canvas, modelpoints) {
					// fill canvas with black
					var cc = canvas.getContext('2d');
					cc.fillStyle="#000000";
					cc.fillRect(0,0,canvas.width, canvas.height);
					cc.beginPath();
					cc.moveTo(modelpoints[0][0], modelpoints[0][1]);
					for (var i = 1;i < modelpoints.length;i++) {
						cc.lineTo(modelpoints[i][0], modelpoints[i][1]);
					}
					cc.lineTo(modelpoints[0][0], modelpoints[0][1]);
					cc.closePath();
					cc.fillStyle="#ffffff";
					cc.fill();
				}
				
				/*********** Code for stats **********/

				stats = new Stats();
				stats.domElement.style.position = 'absolute';
				stats.domElement.style.top = '0px';
				document.getElementById('container').appendChild( stats.domElement );

				document.addEventListener("clmtrackrIteration", function(event) {
					stats.update();
				}, false);

			</script>
		</div>
	</body>
</html>
